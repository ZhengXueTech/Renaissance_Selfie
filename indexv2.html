<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡è—å¾©èˆˆè‡ªæ‹æ©Ÿ - å„ªé›…ç›¸æ¡†é«”é©—</title>
    
    <!-- ç”Ÿç”¢ç’°å¢ƒæ¨£å¼ - å…ˆæ‹ç…§å¾Œå¥—æ¡†ç‰ˆæœ¬ -->
    <style>
        /* é‡ç½®å’ŒåŸºç¤æ¨£å¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 1rem;
            color: #1f2937;
        }

        /* å®¹å™¨å’Œç‰ˆé¢ */
        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
            animation: fadeIn 0.6s ease-out;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: bold;
            color: white;
            margin-bottom: 0.5rem;
            text-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.125rem;
            color: rgba(255, 255, 255, 0.9);
        }

        /* å·¥ä½œæµç¨‹æŒ‡ç¤ºå™¨ */
        .workflow-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .workflow-step {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: rgba(255, 255, 255, 0.6);
            font-weight: 500;
        }

        .workflow-step.active {
            color: white;
        }

        .workflow-step.completed {
            color: #10b981;
        }

        .step-number {
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .workflow-step.active .step-number {
            background: white;
            color: #7c3aed;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
        }

        .workflow-step.completed .step-number {
            background: #10b981;
            color: white;
        }

        /* ä¸»è¦ç¶²æ ¼å¸ƒå±€ */
        .main-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
            margin-bottom: 3rem;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }

        /* å¡ç‰‡æ¨£å¼ */
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* ç›¸æ©Ÿ/ç…§ç‰‡é è¦½å€åŸŸ */
        .preview-container {
            aspect-ratio: 1/1;
            background: #111827;
            border-radius: 0.75rem;
            overflow: hidden;
            position: relative;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
        }

        .media-element {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            min-width: 100%;
            min-height: 100%;
            width: auto;
            height: auto;
            object-fit: cover;
        }

        /* åˆå§‹æç¤ºå€ */
        .placeholder-content {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .camera-icon {
            width: 6rem;
            height: 6rem;
            margin-bottom: 1.5rem;
            opacity: 0.5;
        }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn {
            padding: 0.75rem 2rem;
            font-weight: 600;
            border-radius: 9999px;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
            font-size: 1rem;
            text-decoration: none;
            outline: none;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            justify-content: center;
            margin-top: 1.5rem;
        }

        /* ç•«æ¡†é¸æ“‡å€ - æ­¥é©Ÿ2æ‰é¡¯ç¤º */
        .frame-selector-section {
            display: none;
            animation: fadeIn 0.5s ease-out;
        }

        .frame-selector-section.active {
            display: block;
        }

        .frame-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .frame-item {
            position: relative;
            cursor: pointer;
            border-radius: 0.5rem;
            overflow: hidden;
            transition: all 0.3s ease;
            border: 3px solid transparent;
            background: #f3f4f6;
            padding: 0.25rem;
            aspect-ratio: 1/1;
        }

        .frame-item:hover {
            transform: scale(1.05);
            border-color: #fbbf24;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .frame-item.active {
            border-color: #f59e0b;
            box-shadow: 0 10px 30px rgba(245, 158, 11, 0.4);
            background: #fef3c7;
        }

        .frame-item img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .frame-label {
            position: absolute;
            bottom: 0.5rem;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .frame-item:hover .frame-label {
            opacity: 1;
        }

        /* æœ€çµ‚é è¦½å€ */
        .final-preview-container {
            aspect-ratio: 1/1;
            background: #2d3748;
            border-radius: 0.75rem;
            overflow: hidden;
            position: relative;
            width: 100%;
            max-width: 600px;
            margin: 0 auto 1.5rem;
        }

        .final-photo {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .frame-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
            object-fit: contain;
        }

        /* è¨Šæ¯æç¤º */
        .message {
            margin-top: 1rem;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            text-align: center;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .message.info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        .message.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
        }

        .message.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        /* è¼‰å…¥å‹•ç•« */
        .loader {
            border: 4px solid #e5e7eb;
            border-top: 4px solid #8b5cf6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        .loading-container {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #111827;
            color: white;
        }

        /* å€’æ•¸è¨ˆæ™‚ */
        .countdown-container {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.5);
            z-index: 20;
        }

        .countdown-number {
            font-size: 5rem;
            color: white;
            font-weight: bold;
            animation: pulse 1s ease-in-out;
        }

        /* é–ƒå…‰æ•ˆæœ */
        .flash-effect {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 9999;
            pointer-events: none;
            animation: flashAnimation 0.5s ease-out;
        }

        /* é è…³ */
        .footer {
            text-align: center;
            color: rgba(255, 255, 255, 0.8);
            padding: 2rem 0;
            font-size: 0.875rem;
        }

        /* éš±è—å…ƒç´  */
        .hidden {
            display: none !important;
        }

        /* å‹•ç•« */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0% {
                transform: scale(0.5);
                opacity: 1;
            }
            100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }

        @keyframes flashAnimation {
            0% { opacity: 1; }
            100% { opacity: 0; }
        }

        /* éŸ¿æ‡‰å¼èª¿æ•´ */
        @media (max-width: 640px) {
            .header h1 {
                font-size: 2rem;
            }

            .countdown-number {
                font-size: 3rem;
            }

            .card {
                padding: 1rem;
            }

            .frame-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 0.5rem;
            }

            .workflow-indicator {
                gap: 1rem;
                font-size: 0.875rem;
            }
        }

        /* åœ–æ¨™æ¨£å¼ */
        .icon {
            width: 1.25rem;
            height: 1.25rem;
            display: inline-block;
            vertical-align: middle;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- æ¨™é¡Œ -->
        <header class="header">
            <h1>ğŸ¨ æ–‡è—å¾©èˆˆè‡ªæ‹æ©Ÿ</h1>
            <p>æ‹æ”ç…§ç‰‡ï¼Œé¸æ“‡ç•«æ¡†ï¼Œå‰µé€ è—è¡“å‚‘ä½œ</p>
        </header>

        <!-- å·¥ä½œæµç¨‹æŒ‡ç¤ºå™¨ -->
        <div class="workflow-indicator">
            <div class="workflow-step active" id="step1">
                <div class="step-number">1</div>
                <span>æ‹æ”ç…§ç‰‡</span>
            </div>
            <div class="workflow-step" id="step2">
                <div class="step-number">2</div>
                <span>é¸æ“‡ç•«æ¡†</span>
            </div>
            <div class="workflow-step" id="step3">
                <div class="step-number">3</div>
                <span>ä¸‹è¼‰ä½œå“</span>
            </div>
        </div>

        <!-- ä¸»è¦å…§å®¹ -->
        <div class="main-content">
            <!-- æ­¥é©Ÿ1ï¼šæ‹ç…§å€ -->
            <div class="card" id="cameraSection">
                <h2 class="card-title">
                    <span>ğŸ“¸</span>
                    <span>æ­¥é©Ÿ 1ï¼šæ‹æ”æ‚¨çš„ç…§ç‰‡</span>
                </h2>

                <!-- ç›¸æ©Ÿé è¦½ -->
                <div class="preview-container">
                    <!-- åˆå§‹æç¤º -->
                    <div id="placeholder" class="placeholder-content">
                        <svg class="camera-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        <p style="font-size: 1.125rem; margin-bottom: 1rem;">æº–å‚™å¥½æ‹æ”äº†å—ï¼Ÿ</p>
                        <button onclick="initCamera()" class="btn btn-primary">å•Ÿå‹•ç›¸æ©Ÿ</button>
                    </div>

                    <!-- è¼‰å…¥ä¸­ -->
                    <div id="loading" class="loading-container hidden">
                        <div class="loader"></div>
                        <p>æ­£åœ¨å•Ÿå‹•ç›¸æ©Ÿ...</p>
                    </div>

                    <!-- å€’æ•¸è¨ˆæ™‚ -->
                    <div id="countdown" class="countdown-container hidden">
                        <span class="countdown-number"></span>
                    </div>

                    <!-- è¦–è¨Š -->
                    <video id="camera" class="media-element hidden" autoplay playsinline muted></video>
                    
                    <!-- æ‹æ”çš„ç…§ç‰‡ -->
                    <img id="capturedPhoto" class="media-element hidden" alt="Your Photo">
                </div>

                <!-- éš±è—çš„ Canvas -->
                <canvas id="tempCanvas" class="hidden"></canvas>

                <!-- æ§åˆ¶æŒ‰éˆ• -->
                <div class="btn-group">
                    <button id="captureBtn" onclick="capturePhoto()" disabled class="btn btn-primary">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                            <circle cx="12" cy="13" r="3" stroke-width="2"></circle>
                        </svg>
                        æ‹ç…§ (3ç§’å€’æ•¸)
                    </button>
                    
                    <button id="retakeBtn" onclick="retakePhoto()" class="btn btn-secondary hidden">
                        é‡æ–°æ‹æ”
                    </button>

                    <button id="proceedBtn" onclick="proceedToFrameSelection()" class="btn btn-success hidden">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
                        </svg>
                        ä¸‹ä¸€æ­¥ï¼šé¸æ“‡ç•«æ¡†
                    </button>

                    <button id="switchBtn" onclick="switchCamera()" class="btn btn-info hidden">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        åˆ‡æ›é¡é ­
                    </button>
                </div>

                <!-- è¨Šæ¯é¡¯ç¤º -->
                <div id="message1"></div>
            </div>

            <!-- æ­¥é©Ÿ2ï¼šç•«æ¡†é¸æ“‡ -->
            <div class="card frame-selector-section" id="frameSection">
                <h2 class="card-title">
                    <span>ğŸ–¼ï¸</span>
                    <span>æ­¥é©Ÿ 2ï¼šé¸æ“‡ç•«æ¡†</span>
                </h2>

                <!-- æœ€çµ‚é è¦½ -->
                <div class="final-preview-container">
                    <img id="photoBase" class="final-photo" alt="Your Photo">
                    <img id="frameOverlay" class="frame-overlay" alt="Frame">
                </div>

                <!-- ç•«æ¡†é¸æ“‡ç¶²æ ¼ -->
                <div id="frameGrid" class="frame-grid">
                    <!-- ç•«æ¡†å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
                </div>

                <!-- æœ€çµ‚Canvasç”¨æ–¼åˆæˆ -->
                <canvas id="finalCanvas" class="hidden"></canvas>

                <!-- æŒ‰éˆ•çµ„ -->
                <div class="btn-group">
                    <button onclick="backToCamera()" class="btn btn-secondary">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                        </svg>
                        è¿”å›æ‹ç…§
                    </button>

                    <button id="downloadBtn" onclick="downloadPhoto()" class="btn btn-warning">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg>
                        ä¸‹è¼‰ä½œå“
                    </button>
                </div>

                <!-- è¨Šæ¯é¡¯ç¤º -->
                <div id="message2"></div>
            </div>
        </div>

        <!-- é è…³ -->
        <footer class="footer">
            <p>&copy; 2025 Renaissance Photo Booth - å‰µé€ æ‚¨çš„è—è¡“æ™‚åˆ»</p>
        </footer>
    </div>

    <!-- JavaScript -->
    <script>
        // é…ç½®
        const CONFIG = {
            frames: [
                'Renaissance01.png',
                'Renaissance02.png',
                'Renaissance03.png',
                'Renaissance04.png',
                'Renaissance05.png',
                'Renaissance06.png'
            ],
            countdownSeconds: 3,
            photoQuality: 0.95,
            outputFormat: 'image/png'
        };

        // æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹
        const state = {
            stream: null,
            capturedPhotoData: null,
            selectedFrame: null,
            currentFacingMode: 'user',
            finalPhotoDataUrl: null,
            hasMultipleCameras: false,
            currentStep: 1
        };

        // DOM å…ƒç´ ç·©å­˜
        const elements = {
            // æ­¥é©ŸæŒ‡ç¤ºå™¨
            step1: document.getElementById('step1'),
            step2: document.getElementById('step2'),
            step3: document.getElementById('step3'),
            
            // ç›¸æ©Ÿå€
            cameraSection: document.getElementById('cameraSection'),
            placeholder: document.getElementById('placeholder'),
            loading: document.getElementById('loading'),
            countdown: document.getElementById('countdown'),
            camera: document.getElementById('camera'),
            capturedPhoto: document.getElementById('capturedPhoto'),
            tempCanvas: document.getElementById('tempCanvas'),
            captureBtn: document.getElementById('captureBtn'),
            retakeBtn: document.getElementById('retakeBtn'),
            proceedBtn: document.getElementById('proceedBtn'),
            switchBtn: document.getElementById('switchBtn'),
            message1: document.getElementById('message1'),
            
            // ç•«æ¡†å€
            frameSection: document.getElementById('frameSection'),
            photoBase: document.getElementById('photoBase'),
            frameOverlay: document.getElementById('frameOverlay'),
            frameGrid: document.getElementById('frameGrid'),
            finalCanvas: document.getElementById('finalCanvas'),
            downloadBtn: document.getElementById('downloadBtn'),
            message2: document.getElementById('message2')
        };

        // æ›´æ–°å·¥ä½œæµç¨‹æŒ‡ç¤ºå™¨
        function updateWorkflowIndicator(step) {
            // é‡ç½®æ‰€æœ‰æ­¥é©Ÿ
            elements.step1.className = 'workflow-step';
            elements.step2.className = 'workflow-step';
            elements.step3.className = 'workflow-step';
            
            // æ›´æ–°ç•¶å‰å’Œå·²å®Œæˆçš„æ­¥é©Ÿ
            if (step === 1) {
                elements.step1.classList.add('active');
            } else if (step === 2) {
                elements.step1.classList.add('completed');
                elements.step2.classList.add('active');
            } else if (step === 3) {
                elements.step1.classList.add('completed');
                elements.step2.classList.add('completed');
                elements.step3.classList.add('active');
            }
            
            state.currentStep = step;
        }

        // é¡¯ç¤ºè¨Šæ¯
        function showMessage(text, type = 'info', messageElement = 'message1') {
            const messageDiv = elements[messageElement];
            messageDiv.textContent = text;
            messageDiv.className = `message ${type}`;
            
            // 3ç§’å¾Œè‡ªå‹•æ¸…é™¤
            setTimeout(() => {
                messageDiv.textContent = '';
                messageDiv.className = '';
            }, 3000);
        }

        // åˆå§‹åŒ–ç›¸æ©Ÿ
        async function initCamera() {
            try {
                // é¡¯ç¤ºè¼‰å…¥ä¸­
                elements.placeholder.classList.add('hidden');
                elements.loading.classList.remove('hidden');
                
                // ç›¸æ©Ÿé…ç½®
                const constraints = {
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 1280 },
                        facingMode: state.currentFacingMode
                    }
                };
                
                // è«‹æ±‚ç›¸æ©Ÿæ¬Šé™
                state.stream = await navigator.mediaDevices.getUserMedia(constraints);
                
                // è¨­ç½®è¦–è¨Šæº
                elements.camera.srcObject = state.stream;
                
                // ç­‰å¾…è¼‰å…¥å®Œæˆ
                elements.camera.onloadedmetadata = async () => {
                    elements.loading.classList.add('hidden');
                    elements.camera.classList.remove('hidden');
                    
                    // å•Ÿç”¨æ‹ç…§æŒ‰éˆ•
                    elements.captureBtn.disabled = false;
                    
                    // æª¢æŸ¥å¤šé¡é ­
                    try {
                        const devices = await navigator.mediaDevices.enumerateDevices();
                        const videoInputs = devices.filter(d => d.kind === 'videoinput');
                        if (videoInputs.length > 1) {
                            state.hasMultipleCameras = true;
                            elements.switchBtn.classList.remove('hidden');
                        }
                    } catch (err) {
                        console.log('ç„¡æ³•æšèˆ‰è¨­å‚™:', err);
                    }
                    
                    showMessage('ç›¸æ©Ÿå·²å°±ç·’ï¼è«‹èª¿æ•´ä½ç½®å¾Œæ‹ç…§', 'success');
                };
                
            } catch (error) {
                console.error('ç›¸æ©ŸéŒ¯èª¤:', error);
                elements.loading.classList.add('hidden');
                elements.placeholder.classList.remove('hidden');
                
                let errorMsg = 'ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿ';
                if (error.name === 'NotAllowedError') {
                    errorMsg = 'è«‹å…è¨±ä½¿ç”¨ç›¸æ©Ÿæ¬Šé™';
                } else if (error.name === 'NotFoundError') {
                    errorMsg = 'æœªæª¢æ¸¬åˆ°ç›¸æ©Ÿè¨­å‚™';
                }
                
                showMessage(errorMsg, 'error');
            }
        }

        // åˆ‡æ›ç›¸æ©Ÿ
        async function switchCamera() {
            if (state.stream) {
                // åœæ­¢ç•¶å‰æµ
                state.stream.getTracks().forEach(track => track.stop());
                
                // åˆ‡æ›æ–¹å‘
                state.currentFacingMode = state.currentFacingMode === 'user' ? 'environment' : 'user';
                
                // é‡æ–°åˆå§‹åŒ–
                await initCamera();
            }
        }

        // æ‹ç…§å€’æ•¸è¨ˆæ™‚
        async function capturePhoto() {
            if (!state.stream) return;
            
            elements.captureBtn.disabled = true;
            elements.countdown.classList.remove('hidden');
            
            const countdownNumber = elements.countdown.querySelector('.countdown-number');
            
            // å€’æ•¸è¨ˆæ™‚
            for (let i = CONFIG.countdownSeconds; i > 0; i--) {
                countdownNumber.textContent = i;
                countdownNumber.style.animation = 'none';
                setTimeout(() => {
                    countdownNumber.style.animation = 'pulse 1s ease-in-out';
                }, 10);
                
                if (i > 1) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            elements.countdown.classList.add('hidden');
            
            // é–ƒå…‰æ•ˆæœ
            const flash = document.createElement('div');
            flash.className = 'flash-effect';
            document.body.appendChild(flash);
            setTimeout(() => flash.remove(), 500);
            
            // åŸ·è¡Œæ‹ç…§
            await takePhoto();
        }

        // å¯¦éš›æ‹ç…§ï¼ˆåªæ‹ç…§ï¼Œä¸å¥—æ¡†ï¼‰
        async function takePhoto() {
            const video = elements.camera;
            const canvas = elements.tempCanvas;
            const ctx = canvas.getContext('2d');
            
            // è¨ˆç®—æ­£æ–¹å½¢è£åˆ‡
            const size = Math.min(video.videoWidth, video.videoHeight);
            const offsetX = (video.videoWidth - size) / 2;
            const offsetY = (video.videoHeight - size) / 2;
            
            canvas.width = size;
            canvas.height = size;
            
            // ç¹ªè£½è¦–è¨Šï¼ˆè£åˆ‡æˆæ­£æ–¹å½¢ï¼‰
            ctx.drawImage(video, offsetX, offsetY, size, size, 0, 0, size, size);
            
            // ä¿å­˜ç…§ç‰‡æ•¸æ“š
            state.capturedPhotoData = canvas.toDataURL('image/jpeg', CONFIG.photoQuality);
            
            // é¡¯ç¤ºæ‹æ”çš„ç…§ç‰‡
            elements.capturedPhoto.src = state.capturedPhotoData;
            elements.camera.classList.add('hidden');
            elements.capturedPhoto.classList.remove('hidden');
            
            // åœæ­¢ç›¸æ©Ÿ
            if (state.stream) {
                state.stream.getTracks().forEach(track => track.stop());
                state.stream = null;
            }
            
            // æ›´æ–°æŒ‰éˆ•
            elements.captureBtn.classList.add('hidden');
            elements.switchBtn.classList.add('hidden');
            elements.retakeBtn.classList.remove('hidden');
            elements.proceedBtn.classList.remove('hidden');
            
            showMessage('ç…§ç‰‡æ‹æ”æˆåŠŸï¼æ‚¨å¯ä»¥é‡æ‹æˆ–é¸æ“‡ç•«æ¡†', 'success');
        }

        // é‡æ–°æ‹æ”
        function retakePhoto() {
            elements.capturedPhoto.classList.add('hidden');
            elements.placeholder.classList.remove('hidden');
            elements.captureBtn.classList.remove('hidden');
            elements.retakeBtn.classList.add('hidden');
            elements.proceedBtn.classList.add('hidden');
            
            state.capturedPhotoData = null;
            showMessage('è«‹é‡æ–°å•Ÿå‹•ç›¸æ©Ÿ', 'info');
        }

        // é€²å…¥ç•«æ¡†é¸æ“‡æ­¥é©Ÿ
        function proceedToFrameSelection() {
            if (!state.capturedPhotoData) {
                showMessage('è«‹å…ˆæ‹æ”ç…§ç‰‡', 'error');
                return;
            }
            
            // æ›´æ–°å·¥ä½œæµç¨‹æŒ‡ç¤ºå™¨
            updateWorkflowIndicator(2);
            
            // é¡¯ç¤ºç•«æ¡†é¸æ“‡å€
            elements.frameSection.classList.add('active');
            
            // è¨­ç½®ç…§ç‰‡åŸºåº•
            elements.photoBase.src = state.capturedPhotoData;
            
            // åˆå§‹åŒ–ç•«æ¡†é¸æ“‡å™¨
            initFrameSelector();
            
            // æ»¾å‹•åˆ°ç•«æ¡†é¸æ“‡å€
            elements.frameSection.scrollIntoView({ behavior: 'smooth' });
            
            showMessage('è«‹é¸æ“‡æ‚¨å–œæ­¡çš„ç•«æ¡†', 'info', 'message2');
        }

        // è¿”å›æ‹ç…§æ­¥é©Ÿ
        function backToCamera() {
            updateWorkflowIndicator(1);
            elements.frameSection.classList.remove('active');
            elements.cameraSection.scrollIntoView({ behavior: 'smooth' });
            
            // é‡ç½®ç•«æ¡†é¸æ“‡
            state.selectedFrame = null;
            elements.frameOverlay.src = '';
        }

        // åˆå§‹åŒ–ç•«æ¡†é¸æ“‡å™¨
        function initFrameSelector() {
            if (elements.frameGrid.children.length > 0) return; // å·²åˆå§‹åŒ–
            
            CONFIG.frames.forEach((frameName, index) => {
                const frameItem = document.createElement('div');
                frameItem.className = 'frame-item';
                frameItem.onclick = () => selectFrame(frameName, frameItem);
                
                const img = document.createElement('img');
                img.src = frameName;
                img.alt = `ç•«æ¡† ${index + 1}`;
                
                img.onerror = () => {
                    img.src = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Crect width='200' height='200' fill='%23f3f4f6'/%3E%3Ctext x='50%25' y='45%25' text-anchor='middle' dy='.3em' fill='%23ef4444' font-size='14'%3EPNG%3C/text%3E%3Ctext x='50%25' y='55%25' text-anchor='middle' dy='.3em' fill='%23ef4444' font-size='14'%3Eè¼‰å…¥å¤±æ•—%3C/text%3E%3C/svg%3E`;
                    showMessage(`ç•«æ¡† ${frameName} è¼‰å…¥å¤±æ•—`, 'error', 'message2');
                };
                
                const label = document.createElement('div');
                label.className = 'frame-label';
                label.textContent = `ç•«æ¡† ${index + 1}`;
                
                frameItem.appendChild(img);
                frameItem.appendChild(label);
                elements.frameGrid.appendChild(frameItem);
            });
            
            // é è¨­é¸æ“‡ç¬¬ä¸€å€‹
            const firstFrame = elements.frameGrid.querySelector('.frame-item');
            if (firstFrame) {
                selectFrame(CONFIG.frames[0], firstFrame);
            }
        }

        // é¸æ“‡ç•«æ¡†
        function selectFrame(frameName, element) {
            // æ›´æ–°ç‹€æ…‹
            state.selectedFrame = frameName;
            
            // æ›´æ–°UI
            document.querySelectorAll('.frame-item').forEach(item => {
                item.classList.remove('active');
            });
            element.classList.add('active');
            
            // æ›´æ–°ç•«æ¡†ç–ŠåŠ 
            elements.frameOverlay.src = frameName;
            elements.frameOverlay.onerror = () => {
                showMessage('ç•«æ¡†è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¢ºèªPNGæ ¼å¼', 'error', 'message2');
            };
            
            showMessage(`å·²é¸æ“‡ï¼š${frameName.replace('.png', '')}`, 'success', 'message2');
        }

        // ä¸‹è¼‰æœ€çµ‚ä½œå“
        async function downloadPhoto() {
            if (!state.capturedPhotoData || !state.selectedFrame) {
                showMessage('è«‹å…ˆå®Œæˆæ‹ç…§å’Œé¸æ“‡ç•«æ¡†', 'error', 'message2');
                return;
            }
            
            // æ›´æ–°å·¥ä½œæµç¨‹æŒ‡ç¤ºå™¨
            updateWorkflowIndicator(3);
            
            const canvas = elements.finalCanvas;
            const ctx = canvas.getContext('2d');
            
            // è¨­ç½®ç•«å¸ƒå¤§å°
            canvas.width = 1000;
            canvas.height = 1000;
            
            // è¼‰å…¥ç…§ç‰‡
            const photo = new Image();
            photo.onload = () => {
                // ç¹ªè£½ç…§ç‰‡
                ctx.drawImage(photo, 0, 0, 1000, 1000);
                
                // è¼‰å…¥ç•«æ¡†
                const frame = new Image();
                frame.onload = () => {
                    // ç¹ªè£½ç•«æ¡†ï¼ˆä¿æŒé€æ˜ï¼‰
                    ctx.drawImage(frame, 0, 0, 1000, 1000);
                    
                    // ç”Ÿæˆæœ€çµ‚åœ–ç‰‡
                    state.finalPhotoDataUrl = canvas.toDataURL(CONFIG.outputFormat, CONFIG.photoQuality);
                    
                    // ä¸‹è¼‰
                    const link = document.createElement('a');
                    link.href = state.finalPhotoDataUrl;
                    link.download = `Renaissance_${Date.now()}.png`;
                    link.click();
                    
                    showMessage('ä½œå“å·²ä¸‹è¼‰ï¼æ„Ÿè¬ä½¿ç”¨', 'success', 'message2');
                };
                
                frame.onerror = () => {
                    showMessage('ç•«æ¡†è¼‰å…¥å¤±æ•—', 'error', 'message2');
                };
                
                frame.src = state.selectedFrame;
            };
            
            photo.src = state.capturedPhotoData;
        }

        // é é¢è¼‰å…¥åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', () => {
            // æª¢æŸ¥ç€è¦½å™¨æ”¯æ´
            if (!navigator.mediaDevices?.getUserMedia) {
                showMessage('ç€è¦½å™¨ä¸æ”¯æ´ç›¸æ©ŸåŠŸèƒ½', 'error');
                elements.captureBtn.disabled = true;
            }
        });

        // æ¸…ç†è³‡æº
        window.addEventListener('beforeunload', () => {
            if (state.stream) {
                state.stream.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>
</html>