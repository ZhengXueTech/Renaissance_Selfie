<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title>æ–‡è—å¾©èˆˆè‡ªæ‹æ©Ÿ Pro | é€²éšç•«æ¡†ç›¸æ©Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* åŸºç¤æ¨£å¼ */
        .square-container {
            width: 100%;
            padding-bottom: 100%;
            position: relative;
            background: #000;
        }

        .square-container > * {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 0.75rem;
        }
        
        /* å³æ™‚é è¦½çš„ç•«æ¡†ç–ŠåŠ  */
        #frameOverlay {
            pointer-events: none;
            z-index: 10;
            opacity: 0.9;
        }
        
        /* è¼‰å…¥å‹•ç•« */
        .spinner {
            border-top-color: #3b82f6;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* é¡é ­åˆ‡æ›æŒ‰éˆ• */
        .camera-switch-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 20;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .camera-switch-btn:hover {
            background: rgba(0, 0, 0, 0.7);
            transform: scale(1.1);
        }
        
        /* æ‹–æ”¾å€åŸŸ */
        .drop-zone {
            border: 3px dashed #CBD5E1;
            border-radius: 1rem;
            transition: all 0.3s ease;
        }
        
        .drop-zone.dragover {
            border-color: #3B82F6;
            background: rgba(59, 130, 246, 0.1);
        }
        
        /* æ§‹åœ–è¼”åŠ©ç·š */
        .guide-line {
            position: absolute;
            background: rgba(255, 255, 255, 0.3);
        }
        
        .guide-line.horizontal {
            width: 100%;
            height: 1px;
        }
        
        .guide-line.vertical {
            width: 1px;
            height: 100%;
        }
        
        /* èª¿æ•´æ§åˆ¶é¢æ¿ */
        .adjustment-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
        }
        
        /* è£åˆ‡æ¨¡å¼æŒ‰éˆ• */
        .crop-mode-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            transition: all 0.2s;
        }
        
        .crop-mode-btn.active {
            background: #3B82F6;
            color: white;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans flex flex-col items-center p-4">

    <header class="w-full max-w-5xl mb-6 text-center">
        <h1 class="text-4xl font-extrabold text-indigo-700 mt-4 mb-2">
            ğŸ¨ æ–‡è—å¾©èˆˆè‡ªæ‹æ©Ÿ Pro
        </h1>
        <p class="text-gray-600">å³æ™‚é è¦½ã€ä¸Šå‚³ç…§ç‰‡ã€é¡é ­åˆ‡æ›ã€æ™ºæ…§èª¿æ•´</p>
    </header>

    <main class="w-full max-w-5xl flex flex-col lg:flex-row gap-6">

        <!-- å·¦å´ï¼šä¸»è¦æ“ä½œå€ -->
        <section class="lg:w-2/3 w-full">
            
            <!-- æ¨¡å¼é¸æ“‡ -->
            <div id="modeSelection" class="bg-white p-6 rounded-xl shadow-2xl border border-gray-100 mb-4">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">é¸æ“‡æ¨¡å¼</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <button onclick="app.startCameraMode()" class="flex flex-col items-center p-6 bg-gradient-to-br from-blue-500 to-indigo-600 text-white rounded-xl hover:shadow-lg transition-all">
                        <svg class="w-12 h-12 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 5h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 8H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        <span class="text-lg font-bold">å³æ™‚æ‹ç…§</span>
                        <span class="text-sm mt-1 opacity-90">ä½¿ç”¨ç›¸æ©Ÿæ‹æ”</span>
                    </button>
                    
                    <button onclick="document.getElementById('fileInput').click()" class="flex flex-col items-center p-6 bg-gradient-to-br from-green-500 to-emerald-600 text-white rounded-xl hover:shadow-lg transition-all">
                        <svg class="w-12 h-12 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        <span class="text-lg font-bold">é¸æ“‡ç…§ç‰‡</span>
                        <span class="text-sm mt-1 opacity-90">å¾ç›¸ç°¿ä¸Šå‚³</span>
                    </button>
                </div>
                
                <!-- æ‹–æ”¾å€åŸŸ -->
                <div id="dropZone" class="drop-zone mt-4 p-8 text-center rounded-xl">
                    <p class="text-gray-500">æˆ–å°‡ç…§ç‰‡æ‹–æ”¾åˆ°é€™è£¡</p>
                    <input type="file" id="fileInput" accept="image/*" class="hidden" onchange="app.handleFileSelect(event)">
                </div>
            </div>

            <!-- é è¦½å€ -->
            <div id="previewSection" class="bg-white p-4 rounded-xl shadow-2xl border border-gray-100 hidden">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-xl font-semibold text-gray-700">å³æ™‚é è¦½</h2>
                    <button onclick="app.toggleGuides()" class="text-sm px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-full">
                        <span id="guidesToggle">é¡¯ç¤ºè¼”åŠ©ç·š</span>
                    </button>
                </div>
                
                <div id="previewArea" class="square-container bg-black rounded-xl overflow-hidden relative">
                    
                    <!-- ç›¸æ©Ÿè¦–è¨Šæµ -->
                    <video id="videoFeed" class="hidden" autoplay playsinline></video>
                    
                    <!-- ä¸Šå‚³çš„ç…§ç‰‡ -->
                    <img id="uploadedPhoto" class="hidden" alt="Uploaded Photo">
                    
                    <!-- ç•«æ¡†ç–ŠåŠ å±¤ -->
                    <img id="frameOverlay" src="" alt="Frame Overlay" class="hidden object-contain">
                    
                    <!-- é¡é ­åˆ‡æ›æŒ‰éˆ• -->
                    <button id="cameraSwitchBtn" onclick="app.switchCamera()" class="camera-switch-btn hidden">
                        <span id="cameraIcon" class="text-2xl">ğŸ”„</span>
                    </button>
                    
                    <!-- æ§‹åœ–è¼”åŠ©ç·š -->
                    <div id="compositionGuides" class="hidden" style="position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:15;">
                        <div class="guide-line horizontal" style="top: 33.33%;"></div>
                        <div class="guide-line horizontal" style="top: 66.66%;"></div>
                        <div class="guide-line vertical" style="left: 33.33%;"></div>
                        <div class="guide-line vertical" style="left: 66.66%;"></div>
                    </div>
                    
                    <!-- æœ€çµ‚ç…§ç‰‡ -->
                    <img id="photoOutput" class="hidden" alt="Final Result">
                    
                    <!-- ç‹€æ…‹è¨Šæ¯ -->
                    <div id="statusMessage" class="text-white text-center p-6 w-full h-full flex flex-col items-center justify-center">
                        <div class="spinner w-10 h-10 border-4 border-gray-200 border-solid rounded-full"></div>
                        <p class="mt-2 text-lg">è¼‰å…¥ä¸­...</p>
                    </div>
                </div>

                <!-- èª¿æ•´æ§åˆ¶ -->
                <div id="adjustmentPanel" class="adjustment-panel hidden">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-sm font-medium text-gray-700">ç…§ç‰‡èª¿æ•´</span>
                        <button onclick="app.resetAdjustments()" class="text-xs px-2 py-1 bg-gray-100 hover:bg-gray-200 rounded">é‡è¨­</button>
                    </div>
                    
                    <!-- è£åˆ‡æ¨¡å¼ -->
                    <div id="cropModes" class="hidden mb-3">
                        <div class="flex gap-2 mb-2">
                            <button onclick="app.setCropMode('center')" data-mode="center" class="crop-mode-btn flex-1 bg-gray-100 active">ä¸­å¿ƒ</button>
                            <button onclick="app.setCropMode('cover')" data-mode="cover" class="crop-mode-btn flex-1 bg-gray-100">å¡«æ»¿</button>
                            <button onclick="app.setCropMode('contain')" data-mode="contain" class="crop-mode-btn flex-1 bg-gray-100">å®Œæ•´</button>
                        </div>
                    </div>
                    
                    <!-- ç¸®æ”¾æ§åˆ¶ -->
                    <div class="mb-3">
                        <label class="text-xs text-gray-600">ç¸®æ”¾: <span id="scaleValue">100%</span></label>
                        <input type="range" id="scaleSlider" min="80" max="120" value="100" class="w-full" oninput="app.updateScale(this.value)">
                    </div>
                </div>

                <!-- Canvas -->
                <canvas id="photoCanvas" class="hidden"></canvas>
                
                <!-- å‹•ä½œæŒ‰éˆ• -->
                <div id="actionButtons" class="flex justify-center gap-3 mt-4">
                    <button id="captureButton" onclick="app.capturePhoto()" disabled class="flex items-center px-6 py-3 bg-red-500 hover:bg-red-600 text-white font-bold rounded-full disabled:opacity-50">
                        <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 5h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 8H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                        </svg>
                        æ‹æ”ç…§ç‰‡
                    </button>
                    
                    <button id="applyFrameButton" onclick="app.applyFrame()" class="hidden flex items-center px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white font-bold rounded-full">
                        <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        å¥—ç”¨ç•«æ¡†
                    </button>
                    
                    <button id="downloadButton" onclick="app.downloadImage()" class="hidden flex items-center px-6 py-3 bg-green-500 hover:bg-green-600 text-white font-bold rounded-full">
                        <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg>
                        ä¸‹è¼‰ä½œå“
                    </button>
                    
                    <button onclick="app.resetCapture()" class="hidden" id="retakeButton">
                        <span class="px-6 py-3 bg-gray-400 hover:bg-gray-500 text-white font-bold rounded-full block">é‡æ–°é–‹å§‹</span>
                    </button>
                </div>
            </div>
        </section>

        <!-- å³å´ï¼šç•«æ¡†é¸æ“‡ -->
        <section class="lg:w-1/3 w-full bg-white p-4 rounded-xl shadow-2xl border border-gray-100">
            <h2 class="text-xl font-semibold mb-3 text-gray-700">é¸æ“‡ç•«æ¡†</h2>
            <div id="frameSelector" class="grid grid-cols-3 gap-3"></div>
            <p id="frameStatus" class="mt-4 text-sm text-center text-gray-500">è«‹å…ˆé¸æ“‡æ¨¡å¼</p>
        </section>

    </main>

    <footer class="mt-10 text-gray-500 text-sm text-center">
        <p>&copy; 2025 Renaissance Photo Booth Pro</p>
    </footer>

    <script>
        // æ‡‰ç”¨ç¨‹å¼ä¸»ç‰©ä»¶
        const app = {
            // ç‹€æ…‹è®Šæ•¸
            FRAME_PATHS: [
                'Renaissance01.png',
                'Renaissance02.png',
                'Renaissance03.png',
                'Renaissance04.png',
                'Renaissance05.png',
                'Renaissance06.png'
            ],
            currentMode: null,
            currentFramePath: null,
            stream: null,
            currentCamera: 'user',
            uploadedImage: null,
            guidesVisible: false,
            finalImageURL: null,
            adjustments: {
                scale: 100,
                offsetX: 0,
                offsetY: 0,
                cropMode: 'center',
                focalPoint: { x: 0.5, y: 0.5 }
            },

            // åˆå§‹åŒ–
            init() {
                console.log('åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼...');
                this.renderFrameSelector();
                this.setupDragAndDrop();
                
                // é¸æ“‡ç¬¬ä¸€å€‹ç•«æ¡†ä½œç‚ºé è¨­
                const firstFrame = document.querySelector('#frameSelector img');
                if (firstFrame) {
                    this.selectFrame(this.FRAME_PATHS[0], firstFrame);
                }
            },

            // æ¸²æŸ“ç•«æ¡†é¸æ“‡å™¨
            renderFrameSelector() {
                const selector = document.getElementById('frameSelector');
                selector.innerHTML = '';
                
                this.FRAME_PATHS.forEach((path, index) => {
                    const img = document.createElement('img');
                    img.src = path;
                    img.alt = `Frame ${index + 1}`;
                    img.className = 'w-full h-auto rounded-lg cursor-pointer transition transform hover:scale-105 shadow-md border-4 border-transparent';
                    img.dataset.path = path;
                    img.onclick = () => this.selectFrame(path, img);
                    
                    img.onerror = () => {
                        console.error(`ç„¡æ³•è¼‰å…¥ç•«æ¡†: ${path}`);
                        img.src = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100'%3E%3Crect width='100' height='100' fill='%23ccc'/%3E%3Ctext x='50' y='50' text-anchor='middle' dy='.3em' fill='%23666'%3EFrame ${index+1}%3C/text%3E%3C/svg%3E`;
                    };
                    
                    selector.appendChild(img);
                });
            },

            // é¸æ“‡ç•«æ¡†
            selectFrame(path, element) {
                console.log('é¸æ“‡ç•«æ¡†:', path);
                this.currentFramePath = path;
                
                const frameOverlay = document.getElementById('frameOverlay');
                frameOverlay.src = path;
                
                frameOverlay.onload = () => {
                    frameOverlay.classList.remove('hidden');
                    if (this.currentMode) {
                        document.getElementById('captureButton').disabled = false;
                        document.getElementById('applyFrameButton').disabled = false;
                    }
                };
                
                // æ›´æ–°é¸ä¸­æ¨£å¼
                document.querySelectorAll('#frameSelector img').forEach(img => {
                    img.classList.remove('border-indigo-500');
                    img.classList.add('border-transparent');
                });
                element.classList.add('border-indigo-500');
                
                this.showMessage(`å·²é¸æ“‡ç•«æ¡†ï¼šFrame ${this.FRAME_PATHS.indexOf(path) + 1}`);
            },

            // é–‹å§‹ç›¸æ©Ÿæ¨¡å¼
            async startCameraMode() {
                console.log('é–‹å§‹ç›¸æ©Ÿæ¨¡å¼');
                this.currentMode = 'camera';
                document.getElementById('modeSelection').classList.add('hidden');
                document.getElementById('previewSection').classList.remove('hidden');
                document.getElementById('cameraSwitchBtn').classList.remove('hidden');
                document.getElementById('adjustmentPanel').classList.remove('hidden');
                document.getElementById('cropModes').classList.add('hidden');
                document.getElementById('captureButton').classList.remove('hidden');
                document.getElementById('applyFrameButton').classList.add('hidden');
                
                await this.startCamera();
            },

            // å•Ÿå‹•ç›¸æ©Ÿ
            async startCamera(camera = 'user') {
                try {
                    console.log('å•Ÿå‹•ç›¸æ©Ÿ:', camera);
                    document.getElementById('statusMessage').classList.remove('hidden');
                    
                    if (this.stream) {
                        this.stream.getTracks().forEach(track => track.stop());
                    }
                    
                    const constraints = {
                        video: { facingMode: camera }
                    };
                    
                    this.stream = await navigator.mediaDevices.getUserMedia(constraints);
                    
                    const video = document.getElementById('videoFeed');
                    video.srcObject = this.stream;
                    
                    video.onloadedmetadata = () => {
                        video.play();
                        document.getElementById('statusMessage').classList.add('hidden');
                        video.classList.remove('hidden');
                        document.getElementById('frameOverlay').classList.remove('hidden');
                        
                        if (this.currentFramePath) {
                            document.getElementById('captureButton').disabled = false;
                        }
                        
                        this.showMessage('ç›¸æ©Ÿå·²å•Ÿå‹•');
                    };
                    
                    this.currentCamera = camera;
                    this.updateCameraIcon();
                    
                } catch (err) {
                    console.error('ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—:', err);
                    this.showMessage('ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿï¼Œè«‹æª¢æŸ¥æ¬Šé™', 'error');
                }
            },

            // åˆ‡æ›ç›¸æ©Ÿ
            async switchCamera() {
                const newCamera = this.currentCamera === 'user' ? 'environment' : 'user';
                await this.startCamera(newCamera);
            },

            // æ›´æ–°ç›¸æ©Ÿåœ–ç¤º
            updateCameraIcon() {
                const icon = document.getElementById('cameraIcon');
                icon.textContent = this.currentCamera === 'user' ? 'ğŸ“±' : 'ğŸ“·';
            },

            // è™•ç†æª”æ¡ˆé¸æ“‡
            handleFileSelect(event) {
                const file = event.target.files[0];
                if (file && file.type.match('image.*')) {
                    this.handleFile(file);
                }
            },

            // è™•ç†æª”æ¡ˆ
            handleFile(file) {
                console.log('è™•ç†æª”æ¡ˆ:', file.name);
                this.currentMode = 'upload';
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    this.uploadedImage = new Image();
                    this.uploadedImage.onload = () => {
                        this.displayUploadedImage();
                    };
                    this.uploadedImage.src = e.target.result;
                };
                reader.readAsDataURL(file);
            },

            // é¡¯ç¤ºä¸Šå‚³çš„åœ–ç‰‡
            displayUploadedImage() {
                console.log('é¡¯ç¤ºä¸Šå‚³çš„åœ–ç‰‡');
                document.getElementById('modeSelection').classList.add('hidden');
                document.getElementById('previewSection').classList.remove('hidden');
                document.getElementById('uploadedPhoto').src = this.uploadedImage.src;
                document.getElementById('uploadedPhoto').classList.remove('hidden');
                document.getElementById('statusMessage').classList.add('hidden');
                document.getElementById('frameOverlay').classList.remove('hidden');
                document.getElementById('adjustmentPanel').classList.remove('hidden');
                document.getElementById('cropModes').classList.remove('hidden');
                document.getElementById('applyFrameButton').classList.remove('hidden');
                document.getElementById('captureButton').classList.add('hidden');
                
                if (this.currentFramePath) {
                    document.getElementById('applyFrameButton').disabled = false;
                }
                
                this.showMessage('ç…§ç‰‡å·²è¼‰å…¥ï¼Œå¯ä»¥å¥—ç”¨ç•«æ¡†');
            },

            // æ‹ç…§
            async capturePhoto() {
                console.log('æ‹ç…§ä¸­...');
                const button = document.getElementById('captureButton');
                if (!this.stream || button.disabled) return;
                
                button.disabled = true;
                button.innerHTML = 'è™•ç†ä¸­...';
                
                // ä½¿ç”¨ setTimeout ç¢ºä¿ UI æ›´æ–°
                setTimeout(() => {
                    this.processImage(document.getElementById('videoFeed'));
                }, 100);
            },

            // å¥—ç”¨ç•«æ¡†
            applyFrame() {
                console.log('å¥—ç”¨ç•«æ¡†...');
                if (!this.uploadedImage) return;
                
                const button = document.getElementById('applyFrameButton');
                button.disabled = true;
                button.innerHTML = 'è™•ç†ä¸­...';
                
                // ä½¿ç”¨ setTimeout ç¢ºä¿ UI æ›´æ–°
                setTimeout(() => {
                    this.processImage(document.getElementById('uploadedPhoto'));
                }, 100);
            },

            // è™•ç†åœ–ç‰‡
            processImage(source) {
                console.log('é–‹å§‹è™•ç†åœ–ç‰‡...');
                
                try {
                    const canvas = document.getElementById('photoCanvas');
                    const ctx = canvas.getContext('2d');
                    
                    // è¨­å®šç•«å¸ƒå°ºå¯¸
                    const size = 800;
                    canvas.width = size;
                    canvas.height = size;
                    
                    // æ¸…ç©ºç•«å¸ƒ
                    ctx.clearRect(0, 0, size, size);
                    
                    // ç¹ªè£½ä¾†æºåœ–ç‰‡
                    if (source.tagName === 'VIDEO') {
                        const vw = source.videoWidth;
                        const vh = source.videoHeight;
                        const min = Math.min(vw, vh);
                        const sx = (vw - min) / 2;
                        const sy = (vh - min) / 2;
                        ctx.drawImage(source, sx, sy, min, min, 0, 0, size, size);
                    } else {
                        // ç¹ªè£½ä¸Šå‚³çš„ç…§ç‰‡ï¼ˆä¸­å¿ƒè£åˆ‡ï¼‰
                        const iw = source.naturalWidth;
                        const ih = source.naturalHeight;
                        const min = Math.min(iw, ih);
                        const sx = (iw - min) / 2;
                        const sy = (ih - min) / 2;
                        ctx.drawImage(source, sx, sy, min, min, 0, 0, size, size);
                    }
                    
                    // è¼‰å…¥ä¸¦ç¹ªè£½ç•«æ¡†
                    const frameImage = new Image();
                    
                    frameImage.onerror = () => {
                        console.error('ç•«æ¡†è¼‰å…¥å¤±æ•—');
                        this.showMessage('ç•«æ¡†è¼‰å…¥å¤±æ•—', 'error');
                        this.resetButtons();
                    };
                    
                    frameImage.onload = () => {
                        console.log('ç•«æ¡†è¼‰å…¥æˆåŠŸï¼Œç¹ªè£½ä¸­...');
                        
                        try {
                            // ç¹ªè£½ç•«æ¡†
                            ctx.drawImage(frameImage, 0, 0, size, size);
                            
                            // ç”Ÿæˆæœ€çµ‚åœ–ç‰‡
                            this.finalImageURL = canvas.toDataURL('image/png');
                            
                            // é¡¯ç¤ºçµæœ
                            const output = document.getElementById('photoOutput');
                            output.src = this.finalImageURL;
                            output.classList.remove('hidden');
                            
                            // éš±è—å…¶ä»–å…ƒç´ 
                            document.getElementById('videoFeed').classList.add('hidden');
                            document.getElementById('uploadedPhoto').classList.add('hidden');
                            document.getElementById('frameOverlay').classList.add('hidden');
                            document.getElementById('adjustmentPanel').classList.add('hidden');
                            document.getElementById('cameraSwitchBtn').classList.add('hidden');
                            
                            // æ›´æ–°æŒ‰éˆ•
                            document.getElementById('captureButton').classList.add('hidden');
                            document.getElementById('applyFrameButton').classList.add('hidden');
                            document.getElementById('downloadButton').classList.remove('hidden');
                            document.getElementById('downloadButton').style.display = 'flex';
                            document.getElementById('retakeButton').classList.remove('hidden');
                            
                            // åœæ­¢ç›¸æ©Ÿ
                            if (this.stream) {
                                this.stream.getTracks().forEach(track => track.stop());
                                this.stream = null;
                            }
                            
                            this.showMessage('ä½œå“å®Œæˆï¼');
                            this.resetButtons();
                            
                        } catch (err) {
                            console.error('è™•ç†å¤±æ•—:', err);
                            this.showMessage('è™•ç†å¤±æ•—', 'error');
                            this.resetButtons();
                        }
                    };
                    
                    // é–‹å§‹è¼‰å…¥ç•«æ¡†
                    frameImage.src = this.currentFramePath;
                    
                } catch (err) {
                    console.error('è™•ç†åœ–ç‰‡éŒ¯èª¤:', err);
                    this.showMessage('è™•ç†å¤±æ•—', 'error');
                    this.resetButtons();
                }
            },

            // ä¸‹è¼‰åœ–ç‰‡
            downloadImage() {
                if (!this.finalImageURL) return;
                
                const a = document.createElement('a');
                a.href = this.finalImageURL;
                a.download = `Renaissance_${Date.now()}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                this.showMessage('ä¸‹è¼‰å·²é–‹å§‹');
            },

            // é‡è¨­æŒ‰éˆ•
            resetButtons() {
                const captureBtn = document.getElementById('captureButton');
                const applyBtn = document.getElementById('applyFrameButton');
                
                captureBtn.disabled = false;
                captureBtn.innerHTML = '<svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 5h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 8H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path></svg>æ‹æ”ç…§ç‰‡';
                
                applyBtn.disabled = false;
                applyBtn.innerHTML = '<svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>å¥—ç”¨ç•«æ¡†';
            },

            // é‡æ–°é–‹å§‹
            resetCapture() {
                location.reload();
            },

            // é¡¯ç¤ºè¨Šæ¯
            showMessage(msg, type = 'info') {
                const status = document.getElementById('frameStatus');
                status.textContent = msg;
                status.className = `mt-4 text-sm text-center font-semibold text-${type === 'error' ? 'red' : 'blue'}-500`;
            },

            // è¨­å®šæ‹–æ”¾
            setupDragAndDrop() {
                const dropZone = document.getElementById('dropZone');
                
                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.classList.add('dragover');
                });
                
                dropZone.addEventListener('dragleave', () => {
                    dropZone.classList.remove('dragover');
                });
                
                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('dragover');
                    
                    const file = e.dataTransfer.files[0];
                    if (file && file.type.match('image.*')) {
                        this.handleFile(file);
                    }
                });
            },

            // åˆ‡æ›è¼”åŠ©ç·š
            toggleGuides() {
                this.guidesVisible = !this.guidesVisible;
                const guides = document.getElementById('compositionGuides');
                const toggle = document.getElementById('guidesToggle');
                
                if (this.guidesVisible) {
                    guides.classList.remove('hidden');
                    toggle.textContent = 'éš±è—è¼”åŠ©ç·š';
                } else {
                    guides.classList.add('hidden');
                    toggle.textContent = 'é¡¯ç¤ºè¼”åŠ©ç·š';
                }
            },

            // è¨­å®šè£åˆ‡æ¨¡å¼
            setCropMode(mode) {
                this.adjustments.cropMode = mode;
                
                document.querySelectorAll('.crop-mode-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
            },

            // æ›´æ–°ç¸®æ”¾
            updateScale(value) {
                this.adjustments.scale = value;
                document.getElementById('scaleValue').textContent = value + '%';
            },

            // é‡è¨­èª¿æ•´
            resetAdjustments() {
                this.adjustments = {
                    scale: 100,
                    offsetX: 0,
                    offsetY: 0,
                    cropMode: 'center',
                    focalPoint: { x: 0.5, y: 0.5 }
                };
                
                document.getElementById('scaleSlider').value = 100;
                document.getElementById('scaleValue').textContent = '100%';
                
                this.showMessage('èª¿æ•´å·²é‡è¨­');
            }
        };

        // åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼
        window.onload = () => {
            app.init();
        };
    </script>
</body>
</html>